name: Build, Test and Deploy

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  test:
    name: Build and Test (${{ matrix.platform }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            arch: amd64
          - platform: linux/arm64
            arch: arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image (${{ matrix.arch }})
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: ${{ matrix.platform }}
        load: true
        tags: wordpress-stack:test-${{ matrix.arch }}

    - name: "Test 1: Run container"
      run: |
        docker run -d --name test-container -p 7080:7080 -p 80:80 \
          -e MARIADB_ROOT_PASSWORD=secret \
          -e MARIADB_DATABASE=wordpress \
          -e MARIADB_USER=wp_user \
          -e MARIADB_PASSWORD=wp_pass \
          wordpress-stack:test-${{ matrix.arch }}
        
        echo "Waiting for container initialization (delayed for QEMU)..."
        sleep 60
        
        # Show running processes
        docker exec test-container ps aux || true

    - name: Inspect container logs (if failed)
      if: failure()
      run: docker logs test-container

    - name: "Test 2: Check OLS Admin Console"
      run: |
        echo "Checking OLS Admin availability..."
        for i in {1..10}; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:7080/ || echo "000")
          echo "Attempt $i: OLS Admin Response: $HTTP_CODE"
          
          if [[ "$HTTP_CODE" == "200" ]] || [[ "$HTTP_CODE" == "301" ]] || [[ "$HTTP_CODE" == "302" ]]; then
            echo "PASS: OpenLiteSpeed Admin is running"
            exit 0
          fi
          
          # If curl failed with connection error (000), wait longer
          sleep 10
        done
        
        echo "FAIL: OLS Admin not accessible after retries"
        docker logs test-container
        exit 1

    - name: "Test 3: Check WordPress"
      run: |
        # Check HTTP access on port 80
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/)
        echo "WordPress HTTP Response: $HTTP_CODE"
        if [[ "$HTTP_CODE" -ne 200 ]] && [[ "$HTTP_CODE" -ne 301 ]] && [[ "$HTTP_CODE" -ne 302 ]]; then
          echo "FAIL: WordPress not accessible (Code $HTTP_CODE)"
          exit 1
        fi
        echo "PASS: WordPress is accessible on port 80"
        
        # Check if WordPress files are deployed
        docker exec test-container ls /var/www/vhosts/localhost/html/wp-settings.php
        if [ $? -eq 0 ]; then
           echo "PASS: WordPress files deployed"
        else
           echo "FAIL: WordPress files missing"
           exit 1
        fi
        
        # Check wp-config.php auto-configuration
        docker exec test-container ls /var/www/vhosts/localhost/html/wp-config.php
        if [ $? -eq 0 ]; then
           echo "PASS: wp-config.php created"
        else
           echo "FAIL: wp-config.php not created"
           exit 1
        fi
        
        # Verify database name in wp-config.php
        docker exec test-container grep -q "wordpress" /var/www/vhosts/localhost/html/wp-config.php
        if [ $? -eq 0 ]; then
           echo "PASS: Database configured in wp-config.php"
        else
           echo "FAIL: Database not configured in wp-config.php"
           exit 1
        fi

    - name: "Test 4: Check MariaDB"
      run: |
        docker exec test-container mariadb-admin -u root -psecret ping
        if [ $? -eq 0 ]; then
          echo "PASS: MariaDB is responding"
        else
          echo "FAIL: MariaDB ping failed"
          exit 1
        fi
        
        docker exec test-container mariadb -u wp_user -pwp_pass -e "SELECT CURRENT_USER();"
        if [ $? -eq 0 ]; then
           echo "PASS: Custom database user works"
        else
           echo "FAIL: Custom database user login failed"
           exit 1
        fi

    - name: "Test 5: Check phpMyAdmin"
      run: |
        HTTP_CODE=$(curl -s -L -o /dev/null -w "%{http_code}" http://localhost:80/phpmyadmin/)
        echo "PMA Response: $HTTP_CODE"
        if [[ "$HTTP_CODE" -ne 200 ]]; then
           echo "FAIL: phpMyAdmin inaccessible (Code $HTTP_CODE)"
           exit 1
        fi
        echo "PASS: phpMyAdmin is accessible"

    - name: Cleanup
      if: always()
      run: docker rm -f test-container || true

  deploy:
    name: Push Multi-Arch to Registry
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and Push Multi-Arch Image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ghcr.io/${{ github.repository }}:${{ github.ref_name }}
