name: Build, Test and Deploy

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build -t wordpress-stack:test .

    - name: "Test 1: Run container"
      run: |
        docker run -d --name test-container -p 7080:7080 -p 80:80 \
          -e MARIADB_ROOT_PASSWORD=secret \
          -e MARIADB_DATABASE=wordpress \
          -e MARIADB_USER=wp_user \
          -e MARIADB_PASSWORD=wp_pass \
          wordpress-stack:test
        
        echo "Waiting for container initialization..."
        sleep 30

    - name: Inspect container logs (if failed)
      if: failure()
      run: docker logs test-container

    - name: "Test 2: Check OLS Admin Console"
      run: |
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:7080/)
        echo "OLS Admin Response: $HTTP_CODE"
        if [[ "$HTTP_CODE" -ne 200 ]] && [[ "$HTTP_CODE" -ne 301 ]] && [[ "$HTTP_CODE" -ne 302 ]]; then
          echo "FAIL: OLS Admin not accessible (Code $HTTP_CODE)"
          exit 1
        fi
        echo "PASS: OpenLiteSpeed Admin is running"

    - name: "Test 3: Check WordPress"
      run: |
        # Check HTTP access on port 80
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/)
        echo "WordPress HTTP Response: $HTTP_CODE"
        if [[ "$HTTP_CODE" -ne 200 ]] && [[ "$HTTP_CODE" -ne 301 ]] && [[ "$HTTP_CODE" -ne 302 ]]; then
          echo "FAIL: WordPress not accessible (Code $HTTP_CODE)"
          exit 1
        fi
        echo "PASS: WordPress is accessible on port 80"
        
        # Check if WordPress files are deployed
        docker exec test-container ls /var/www/vhosts/localhost/html/wp-settings.php
        if [ $? -eq 0 ]; then
           echo "PASS: WordPress files deployed"
        else
           echo "FAIL: WordPress files missing"
           exit 1
        fi
        
        # Check wp-config.php auto-configuration
        docker exec test-container ls /var/www/vhosts/localhost/html/wp-config.php
        if [ $? -eq 0 ]; then
           echo "PASS: wp-config.php created"
        else
           echo "FAIL: wp-config.php not created"
           exit 1
        fi
        
        # Verify database name in wp-config.php
        docker exec test-container grep -q "wordpress" /var/www/vhosts/localhost/html/wp-config.php
        if [ $? -eq 0 ]; then
           echo "PASS: Database configured in wp-config.php"
        else
           echo "FAIL: Database not configured in wp-config.php"
           exit 1
        fi

    - name: "Test 4: Check MariaDB"
      run: |
        docker exec test-container mariadb-admin -u root -psecret ping
        if [ $? -eq 0 ]; then
          echo "PASS: MariaDB is responding"
        else
          echo "FAIL: MariaDB ping failed"
          exit 1
        fi
        
        docker exec test-container mariadb -u wp_user -pwp_pass -e "SELECT CURRENT_USER();"
        if [ $? -eq 0 ]; then
           echo "PASS: Custom database user works"
        else
           echo "FAIL: Custom database user login failed"
           exit 1
        fi

    - name: "Test 5: Check phpMyAdmin"
      run: |
        HTTP_CODE=$(curl -s -L -o /dev/null -w "%{http_code}" http://localhost:80/phpmyadmin/)
        echo "PMA Response: $HTTP_CODE"
        if [[ "$HTTP_CODE" -ne 200 ]]; then
           echo "FAIL: phpMyAdmin inaccessible (Code $HTTP_CODE)"
           exit 1
        fi
        echo "PASS: phpMyAdmin is accessible"

  deploy:
    name: Push to Registry
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build -t wordpress-stack:latest .

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Tag and Push to GHCR
      run: |
        IMAGE_NAME=ghcr.io/${{ github.repository }}:${{ github.ref_name }}
        docker tag wordpress-stack:latest $IMAGE_NAME
        docker push $IMAGE_NAME
        echo "Pushed image: $IMAGE_NAME"
