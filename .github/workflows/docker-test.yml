name: Build and Test Docker Image

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build -t myols-db:test .

    - name: "Test 1: Run container"
      run: |
        docker run -d --name test-container -p 7080:7080 -p 80:80 \
          -e MARIADB_ROOT_PASSWORD=secret \
          -e MARIADB_DATABASE=wordpress \
          -e MARIADB_USER=wp_user \
          -e MARIADB_PASSWORD=wp_pass \
          myols-db:test
        
        # Wait for initialization (MariaDB start, WP/PMA copy)
        echo "Waiting for container initialization..."
        sleep 30

    - name: Inspect container logs (if failed)
      if: failure()
      run: docker logs test-container

    - name: "Test 2: Check OLS Admin Console (Port 7080)"
      run: |
        # Check OLS admin console access
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:7080/)
        echo "OLS Admin Response: $HTTP_CODE"
        if [[ "$HTTP_CODE" -ne 200 ]] && [[ "$HTTP_CODE" -ne 301 ]] && [[ "$HTTP_CODE" -ne 302 ]]; then
          echo "FAIL: OLS Admin not accessible (Code $HTTP_CODE)"
          exit 1
        fi
        echo "PASS: OpenLiteSpeed Admin is running"

    - name: "Test 3: Check WordPress (Port 80)"
      run: |
        # Check WordPress on port 80
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/)
        echo "WordPress Response: $HTTP_CODE"
        if [[ "$HTTP_CODE" -ne 200 ]] && [[ "$HTTP_CODE" -ne 301 ]] && [[ "$HTTP_CODE" -ne 302 ]]; then
          echo "FAIL: WordPress not accessible (Code $HTTP_CODE)"
          exit 1
        fi
        echo "PASS: WordPress is accessible"

    - name: "Test 4: Check MariaDB Connectivity"
      run: |
        # Use docker exec to check DB inside
        docker exec test-container mariadb-admin -u root -psecret ping
        if [ $? -eq 0 ]; then
          echo "PASS: MariaDB is responding"
        else
          echo "FAIL: MariaDB ping failed"
          exit 1
        fi
        
        # Check explicit user creation
        docker exec test-container mariadb -u wp_user -pwp_pass -e "SELECT CURRENT_USER();"
        if [ $? -eq 0 ]; then
           echo "PASS: Custom database user works"
        else
           echo "FAIL: Custom database user login failed"
           exit 1
        fi

    - name: "Test 5: Check WordPress Deployment"
      run: |
        # Check if wp-settings.php exists in webroot
        docker exec test-container ls /var/www/vhosts/localhost/html/wp-settings.php
        if [ $? -eq 0 ]; then
           echo "PASS: WordPress files found"
        else
           echo "FAIL: WordPress missing from /var/www/vhosts/localhost/html/"
           exit 1
        fi

    - name: "Test 6: Check phpMyAdmin Deployment"
      run: |
        # Check HTTP access to PMA on port 80
        HTTP_CODE=$(curl -s -L -o /dev/null -w "%{http_code}" http://localhost:80/phpmyadmin/)
        echo "PMA Response: $HTTP_CODE"
        if [[ "$HTTP_CODE" -ne 200 ]]; then
           echo "FAIL: phpMyAdmin inaccessible (Code $HTTP_CODE)"
           exit 1
        fi
        echo "PASS: phpMyAdmin is accessible"

    # Push to GitHub Container Registry (only on push, not PR)
    - name: Log in to GitHub Container Registry
      if: github.event_name == 'push'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Tag and Push to GHCR
      if: github.event_name == 'push'
      run: |
        IMAGE_NAME=ghcr.io/${{ github.repository }}:${{ github.ref_name }}
        docker tag myols-db:test $IMAGE_NAME
        docker push $IMAGE_NAME
        echo "Pushed image: $IMAGE_NAME"
